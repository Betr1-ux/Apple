<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ğŸ Apple Game</title>
<style>
  body {
    margin: 0;
    font-family: 'Cairo', sans-serif;
    background: radial-gradient(circle at center, #4b2a15 0%, #2a180c 100%);
    color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    overflow: hidden;
  }

  body::before {
    content: "";
    position: fixed;
    inset: 0;
    background: repeating-linear-gradient(
      to bottom,
      rgba(0, 255, 102, 0.06) 0px,
      rgba(0, 255, 102, 0.06) 2px,
      transparent 2px,
      transparent 4px
    );
    animation: hackerScroll 12s linear infinite;
    pointer-events: none;
  }
  @keyframes hackerScroll {
    from { background-position-y: 0; }
    to { background-position-y: 100%; }
  }

  .card {
    text-align: center;
    background: rgba(60, 40, 20, 0.95);
    padding: 25px;
    border-radius: 14px;
    box-shadow: 0 0 25px rgba(0,255,128,0.3);
    width: min(95vw, 420px);
    position: relative;
    backdrop-filter: blur(8px);
  }

  h1 {
    color: #00ff99;
    font-size: 28px;
    margin-bottom: 15px;
    text-shadow: 0 0 12px #00ff99;
  }

  .input {
    width: 100%;
    height: 44px;
    border: none;
    border-radius: 10px;
    margin: 6px 0;
    padding: 0 10px;
    text-align: center;
    font-size: 16px;
    background: #3a2410;
    color: #fff;
  }

  .input:focus {
    outline: 2px solid #00ff99;
    box-shadow: 0 0 10px #00ff99;
  }

  .error {
    display: none;
    color: #ff5555;
    font-weight: 700;
    margin: 6px 0;
  }

  button {
    padding: 12px 24px;
    border: none;
    border-radius: 10px;
    background: linear-gradient(90deg, #00ff99, #44ffaa);
    color: #05200d;
    font-size: 16px;
    cursor: pointer;
    font-weight: bold;
    box-shadow: 0 0 15px rgba(0,255,128,0.6);
    transition: 0.3s;
  }

  button:hover {
    transform: scale(1.05);
    box-shadow: 0 0 25px rgba(0,255,128,0.8);
  }

  .badge {
    background: rgba(255, 255, 255, 0.1);
    padding: 8px 14px;
    border-radius: 10px;
    margin: 10px auto;
    display: inline-block;
    box-shadow: inset 0 0 8px rgba(0,255,128,0.4);
  }

  .row {
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 10px 0;
    gap: 10px;
  }

  .mult {
    background: #00ff99;
    color: #05200d;
    padding: 8px;
    border-radius: 8px;
    font-weight: bold;
    min-width: 70px;
  }

  .slots {
    display: flex;
    gap: 10px;
  }

  .slot {
    width: 46px;
    height: 46px;
    background: #fff;
    border-radius: 8px;
    font-size: 26px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #000;
  }

  .loader {
    border: 6px solid #fff;
    border-top: 6px solid #00ff99;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    animation: spin 1s linear infinite;
    margin: 20px auto;
    display: none;
  }

  @keyframes spin {
    0% { transform: rotate(0); }
    100% { transform: rotate(360deg); }
  }

  .telegram-btn {
    position: absolute;
    bottom: -60px;
    left: 50%;
    transform: translateX(-50%);
    background: #0088cc;
    border-radius: 50%;
    width: 56px;
    height: 56px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 0 15px rgba(0,136,204,0.6);
    cursor: pointer;
    transition: 0.3s;
  }

  .telegram-btn img {
    width: 28px;
    height: 28px;
  }

  .inactive-overlay {
    margin-top: 15px;
    background: rgba(255, 50, 50, 0.1);
    color: #ff5555;
    padding: 10px;
    border-radius: 10px;
    border: 1px solid #ff5555;
  }
</style>
</head>
<body>

<!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div id="loginBox" class="card">
  <h1>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h1>
  <input id="userId" class="input" type="text" placeholder="ID" />
  <input id="code" class="input" type="text" placeholder="Code" autocomplete="one-time-code" />
  <div id="errorMsg" class="error">ÙƒÙˆØ¯ Ø®Ø·Ø£ Ø£Ùˆ Ø§Ù†ØªÙ‡Ù‰</div>
  <button onclick="login()">ØªØ£ÙƒÙŠØ¯</button>

  <a href="https://t.me/Loty122" target="_blank" class="telegram-btn">
    <img src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg" alt="Telegram"/>
  </a>
</div>

<!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© -->
<div id="gameBox" class="card" style="display:none;">
  <h1>ğŸ Apple Game</h1>
  <div class="badge">Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª: <b id="attempts">0</b></div>
  <div id="inactiveMsg" class="inactive-overlay" style="display:none;">
    ğŸ”’ Ø§Ù„Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…ÙØ¹Ù„ â€“ Ø¨Ø±Ø¬Ø§Ø¡ Ù„Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø£Ø¯Ù…Ù† @Loty122
  </div>

  <div id="gameArea">
    <div class="row">
      <div class="mult">X4.02</div>
      <div class="slots"><div class="slot"></div><div class="slot"></div><div class="slot"></div><div class="slot"></div><div class="slot"></div></div>
    </div>
    <div class="row">
      <div class="mult">X2.41</div>
      <div class="slots"><div class="slot"></div><div class="slot"></div><div class="slot"></div><div class="slot"></div><div class="slot"></div></div>
    </div>
    <div class="row">
      <div class="mult">X1.93</div>
      <div class="slots"><div class="slot"></div><div class="slot"></div><div class="slot"></div><div class="slot"></div><div class="slot"></div></div>
    </div>
    <div class="row">
      <div class="mult">X1.54</div>
      <div class="slots"><div class="slot"></div><div class="slot"></div><div class="slot"></div><div class="slot"></div><div class="slot"></div></div>
    </div>
    <div class="row">
      <div class="mult">X1.23</div>
      <div class="slots"><div class="slot"></div><div class="slot"></div><div class="slot"></div><div class="slot"></div><div class="slot"></div></div>
    </div>

    <div class="loader" id="loader"></div>

    <div style="margin-top:20px;display:flex;gap:15px;justify-content:center;">
      <button id="showBtn" onclick="startShowApples()">Show Apple</button>
      <button id="resetBtn" onclick="resetGame()">Reset Game</button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getDatabase, ref, get, update, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD08Eud45qyQH8vV6lRQYyDhpvBY5ZXRbE",
    authDomain: "king-admin-1a7ca.firebaseapp.com",
    databaseURL: "https://king-admin-1a7ca-default-rtdb.firebaseio.com",
    projectId: "king-admin-1a7ca",
    storageBucket: "king-admin-1a7ca.firebasestorage.app",
    messagingSenderId: "942166600491",
    appId: "1:942166600491:web:1962bba7655ddd0926b36e",
    measurementId: "G-6BY7G3RZBC"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  let attempts = 0;
  let currentCode = "";
  let userId = "";
  let isActive = false;

  window.login = async () => {
    userId = document.getElementById("userId").value.trim();
    const codeInput = document.getElementById("code").value.trim();
    const errorMsg = document.getElementById("errorMsg");

    if (!userId || !codeInput) {
      errorMsg.style.display = "block";
      errorMsg.textContent = "Ø§Ø¯Ø®Ù„ ID ÙˆØ§Ù„ÙƒÙˆØ¯";
      return;
    }

    try {
      const snap = await get(ref(db, "codes/" + codeInput));
      if (!snap.exists()) throw new Error("invalid");
      const data = snap.val();
      if ((data.remaining ?? 0) <= 0) throw new Error("exhausted");

      currentCode = codeInput;
      attempts = data.remaining;
      await update(ref(db, "codes/" + codeInput), { user: userId });

      // âœ… Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø¹Ø¨Ø© ÙˆÙ„ÙƒÙ† Ù…ØºÙ„Ù‚Ø© Ù„Ø­ÙŠÙ† Ø§Ù„ØªÙØ¹ÙŠÙ„
      document.getElementById("loginBox").style.display = "none";
      document.getElementById("gameBox").style.display = "block";
      updateAttemptsUI();

      // Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù…Ù† Ø§Ù„Ø£Ø¯Ù…Ù† Ù…Ø¨Ø§Ø´Ø±Ø©
      onValue(ref(db, "users/" + userId + "/active"), (snap) => {
        isActive = snap.exists() && snap.val() === true;
        if (isActive) {
          document.getElementById("inactiveMsg").style.display = "none";
          document.getElementById("showBtn").disabled = false;
          document.getElementById("resetBtn").disabled = false;
          document.getElementById("gameArea").style.opacity = "1";
        } else {
          document.getElementById("inactiveMsg").style.display = "block";
          document.getElementById("showBtn").disabled = true;
          document.getElementById("resetBtn").disabled = true;
          document.getElementById("gameArea").style.opacity = "0.3";
        }
      });
    } catch (e) {
      errorMsg.style.display = "block";
      errorMsg.textContent = "ÙƒÙˆØ¯ Ø®Ø·Ø£ Ø£Ùˆ Ø§Ù†ØªÙ‡Ù‰";
    }
  };

  function updateAttemptsUI() {
    document.getElementById("attempts").textContent = attempts;
  }

  function logoutAuto() {
    document.getElementById("gameBox").style.display = "none";
    document.getElementById("loginBox").style.display = "block";
    document.querySelectorAll(".slot").forEach(s => s.textContent = "");
    document.getElementById("loader").style.display = "none";
    currentCode = "";
  }

  window.startShowApples = async () => {
    if (!isActive) return;
    if (attempts <= 0) {
      logoutAuto();
      return;
    }
    attempts--;
    updateAttemptsUI();
    await update(ref(db, "codes/" + currentCode), { remaining: attempts });

    document.getElementById("loader").style.display = "block";
    document.querySelectorAll(".slot").forEach(s => s.textContent = "");

    setTimeout(() => {
      document.getElementById("loader").style.display = "none";
      showApples();

      if (attempts <= 0) {
        setTimeout(() => logoutAuto(), 1000);
      }
    }, 2000);
  };

  function showApples() {
    document.querySelectorAll(".row").forEach(row => {
      let slots = row.querySelectorAll(".slot");
      let randomIndex = Math.floor(Math.random() * slots.length);
      slots[randomIndex].textContent = "ğŸ";
    });
  }

  window.resetGame = () => {
    if (!isActive) return;
    document.querySelectorAll(".slot").forEach(s => s.textContent = "");
    document.getElementById("loader").style.display = "none";
  };
</script>
</body>
</html>
